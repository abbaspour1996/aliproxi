#!/bin/bash

# Define colors for better output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}سلام علی جان، اسکریپت نصب و به‌روزرسانی پروکسی MTProtoProxy در حال اجراست!${NC}"
echo -e "${YELLOW}این اسکریپت به‌طور خودکار پروکسی شما را نصب، پیکربندی و هر یک دقیقه به‌روزرسانی می‌کند.${NC}"

# --- Function to check if a command exists ---
command_exists () {
    type "$1" &> /dev/null ;
}

# --- Check for root privileges ---
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}خطا: این اسکریپت باید با دسترسی روت اجرا بشه. لطفاً از 'sudo su -' یا 'sudo ./scriptname.sh' استفاده کنید.${NC}"
   exit 1
fi

# --- Check if Python3 is installed ---
command_exists python3 || { echo -e "${RED}Python3 is not installed. Please install it first.${NC}"; exit 1; }

# --- Update system and install prerequisites ---
echo -e "${YELLOW}در حال به‌روزرسانی پکیج‌ها و نصب پیش‌نیازها...${NC}"
apt update -y && apt upgrade -y

# Check if required packages are installed, if not, install them
REQUIRED_PACKAGES="git python3 python3-pip curl wget"
for PKG in $REQUIRED_PACKAGES; do
    if ! command_exists $PKG; then
        echo -e "${YELLOW}نصب پکیج مورد نیاز: $PKG...${NC}"
        apt install -y $PKG
        if [ $? -ne 0 ]; then
            echo -e "${RED}خطا در نصب $PKG. لطفاً به صورت دستی نصب کنید و دوباره تلاش کنید.${NC}"
            exit 1
        fi
    fi
done

echo -e "${GREEN}پیش‌نیازها با موفقیت نصب یا بررسی شدند.${NC}"

# --- Download MTProtoProxyInstaller ---
INSTALLER_DIR="/opt/MTProtoProxyInstaller"
echo -e "${YELLOW}در حال دانلود MTProtoProxyInstaller از گیت‌هاب...${NC}"
if [ ! -d "$INSTALLER_DIR" ]; then
    git clone https://github.com/HirbodBehnam/MTProtoProxyInstaller.git $INSTALLER_DIR
    if [ $? -ne 0 ]; then
        echo -e "${RED}خطا در دانلود MTProtoProxyInstaller. لطفاً اتصال اینترنت خود را بررسی کنید.${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}دایرکتوری $INSTALLER_DIR از قبل وجود داره. در حال به‌روزرسانی...${NC}"
    cd $INSTALLER_DIR && git pull
fi

cd $INSTALLER_DIR

# --- Automatically set the secret and port ---
SECRET=$(head -c 16 /dev/urandom | xxd -p)
PORT=$(shuf -i 1024-65535 -n 1)

# --- Create a config file with the generated SECRET and PORT ---
echo -e "${YELLOW}در حال پیکربندی پروکسی با secret و port رندوم...${NC}"
cat <<EOL > config.py
SECRET = "$SECRET"
PORT = $PORT
EOL

# --- Check if install script exists ---
INSTALL_SCRIPT="MTProtoProxyInstall.sh"
if [ ! -f "$INSTALL_SCRIPT" ]; then
    echo -e "${RED}فایل اسکریپت نصب ($INSTALL_SCRIPT) یافت نشد. لطفاً ساختار پروژه را بررسی کنید.${NC}"
    exit 1
fi

# --- Run the installer script ---
echo -e "${YELLOW}در حال اجرای اسکریپت نصب MTProtoProxy...${NC}"

# Automatically answer the questions by echoing responses
echo -e "${YELLOW}در حال انتخاب پورت رندوم و secret...${NC}"
echo "$PORT" | bash $INSTALL_SCRIPT

if [ $? -ne 0 ]; then
    echo -e "${RED}خطا در اجرای اسکریپت نصب. لطفاً لاگ‌ها را بررسی کنید.${NC}"
    exit 1
fi

# --- Restart the service (if needed) ---
echo -e "${YELLOW}در حال راه‌اندازی یا ریستارت سرویس MTProtoProxy...${NC}"
systemctl restart mtproxy

# --- Infinite loop to automatically select "Upgrade proxy software" every minute ---
while true; do
    echo -e "${YELLOW}در حال به‌روزرسانی پروکسی...${NC}"
    
    # Send the input to automatically upgrade the proxy software
    echo "2" | bash $INSTALL_SCRIPT

    # Delay for 1 minute before repeating
    sleep 60
done
