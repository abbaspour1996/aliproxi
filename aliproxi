#!/bin/bash

# Define colors for better output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}سلام علی جان، اسکریپت نصب خودکار MTProtoProxy در حال اجراست!${NC}"
echo -e "${YELLOW}این اسکریپت به‌طور خودکار پروکسی شما را نصب و پیکربندی می‌کند.${NC}"

# --- Function to check if a command exists ---
command_exists () {
    type "$1" &> /dev/null ;
}

# --- Check for root privileges ---
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}خطا: این اسکریپت باید با دسترسی روت اجرا بشه. لطفاً از 'sudo su -' یا 'sudo ./scriptname.sh' استفاده کنید.${NC}"
   exit 1
fi

# --- Check if Python3 is installed ---
command_exists python3 || { echo -e "${RED}Python3 is not installed. Please install it first.${NC}"; exit 1; }

# --- Update system and install prerequisites ---
echo -e "${YELLOW}در حال به‌روزرسانی پکیج‌ها و نصب پیش‌نیازها...${NC}"
apt update -y && apt upgrade -y

# Check if required packages are installed, if not, install them
REQUIRED_PACKAGES="git python3 python3-pip curl wget"
for PKG in $REQUIRED_PACKAGES; do
    if ! command_exists $PKG; then
        echo -e "${YELLOW}نصب پکیج مورد نیاز: $PKG...${NC}"
        apt install -y $PKG
        if [ $? -ne 0 ]; then
            echo -e "${RED}خطا در نصب $PKG. لطفاً به صورت دستی نصب کنید و دوباره تلاش کنید.${NC}"
            exit 1
        fi
    fi
done

echo -e "${GREEN}پیش‌نیازها با موفقیت نصب یا بررسی شدند.${NC}"

# --- Download MTProtoProxyInstaller ---
INSTALLER_DIR="/opt/MTProtoProxyInstaller"
echo -e "${YELLOW}در حال دانلود MTProtoProxyInstaller از گیت‌هاب...${NC}"
if [ ! -d "$INSTALLER_DIR" ]; then
    git clone https://github.com/HirbodBehnam/MTProtoProxyInstaller.git $INSTALLER_DIR
    if [ $? -ne 0 ]; then
        echo -e "${RED}خطا در دانلود MTProtoProxyInstaller. لطفاً اتصال اینترنت خود را بررسی کنید.${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}دایرکتوری $INSTALLER_DIR از قبل وجود داره. در حال به‌روزرسانی...${NC}"
    cd $INSTALLER_DIR && git pull
fi

cd $INSTALLER_DIR

# --- Automatically set the username, secret, and port ---
USERNAME="MTSecret1"  # Username for secret
SECRET=$(head -c 16 /dev/urandom | xxd -p)  # Random secret
PORT=443  # Define the port (you can change this as needed)

# --- Create a config file with the generated SECRET, PORT, and USERNAME ---
echo -e "${YELLOW}در حال پیکربندی پروکسی با username، secret و port...${NC}"
cat <<EOL > config.py
SECRET = "$SECRET"
PORT = $PORT
USERNAME = "$USERNAME"
EOL

# --- Check if install script exists ---
INSTALL_SCRIPT="MTProtoProxyInstall.sh"
if [ ! -f "$INSTALL_SCRIPT" ]; then
    echo -e "${RED}فایل اسکریپت نصب ($INSTALL_SCRIPT) یافت نشد. لطفاً ساختار پروژه را بررسی کنید.${NC}"
    exit 1
fi

# --- Run the installer script ---
echo -e "${YELLOW}در حال اجرای اسکریپت نصب MTProtoProxy...${NC}"

# Automatically answer the questions by echoing responses
# Select port (443)
# Enter username (MTSecret1)
# Select to create a random secret (2)
# Do not limit users (n)
# Do not add another secret (n)
# Restrict to TLS connection only (3)
# Do not setup advertising tag (n)
# Set DPI host to www.cloudflare.com
echo -e "443\nMTSecret1\n2\nn\nn\n3\nn\nwww.cloudflare.com\n" | bash $INSTALL_SCRIPT

if [ $? -ne 0 ]; then
    echo -e "${RED}خطا در اجرای اسکریپت نصب. لطفاً لاگ‌ها را بررسی کنید.${NC}"
    exit 1
fi

# --- Restart the service (if needed) ---
echo -e "${YELLOW}در حال راه‌اندازی یا ریستارت سرویس MTProtoProxy...${NC}"
systemctl restart mtproxy

echo -e "${GREEN}نصب MTProtoProxy با موفقیت انجام شد!${NC}"
echo -e "${GREEN}اطلاعات اتصال پروکسی شما باید پس از اتمام اسکریپت نصب نمایش داده شده باشد.${NC}"
echo ""
