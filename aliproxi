#!/bin/bash

# Define colors for better output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}سلام علی جان، خوش اومدی به اسکریپت نصب خودکار MTProtoProxy!${NC}"
echo -e "${YELLOW}این اسکریپت MTProtoProxy رو روی سرور شما نصب و پیکربندی می‌کنه.${NC}"
echo -e "${YELLOW}لطفاً مطمئن بشید که روی سیستم عامل Debian/Ubuntu هستید و دسترسی روت دارید.${NC}"
echo ""

# --- Function to check if a command exists ---
command_exists () {
    type "$1" &> /dev/null ;
}

# --- Check for root privileges ---
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}خطا: این اسکریپت باید با دسترسی روت اجرا بشه. لطفاً از 'sudo su -' یا 'sudo ./scriptname.sh' استفاده کنید.${NC}"
   exit 1
fi

# --- Check if Python3 is installed ---
command_exists python3 || { echo -e "${RED}Python3 is not installed. Please install it first.${NC}"; exit 1; }

# --- Update system and install prerequisites ---
echo -e "${YELLOW}در حال به‌روزرسانی پکیج‌ها و نصب پیش‌نیازها...${NC}"
apt update -y && apt upgrade -y

# Check if required packages are installed, if not, install them
REQUIRED_PACKAGES="git python3 python3-pip curl wget"
for PKG in $REQUIRED_PACKAGES; do
    if ! command_exists $PKG; then
        echo -e "${YELLOW}نصب پکیج مورد نیاز: $PKG...${NC}"
        apt install -y $PKG
        if [ $? -ne 0 ]; then
            echo -e "${RED}خطا در نصب $PKG. لطفاً به صورت دستی نصب کنید و دوباره تلاش کنید.${NC}"
            exit 1
        fi
    fi
done

echo -e "${GREEN}پیش‌نیازها با موفقیت نصب یا بررسی شدند.${NC}"

# --- Download MTProtoProxyInstaller ---
INSTALLER_DIR="/opt/MTProtoProxyInstaller"
echo -e "${YELLOW}در حال دانلود MTProtoProxyInstaller از گیت‌هاب...${NC}"
if [ ! -d "$INSTALLER_DIR" ]; then
    git clone https://github.com/HirbodBehnam/MTProtoProxyInstaller.git $INSTALLER_DIR
    if [ $? -ne 0 ]; then
        echo -e "${RED}خطا در دانلود MTProtoProxyInstaller. لطفاً اتصال اینترنت خود را بررسی کنید.${NC}"
        exit 1
    fi
else
    echo -e "${YELLOW}دایرکتوری $INSTALLER_DIR از قبل وجود داره. در حال به‌روزرسانی...${NC}"
    cd $INSTALLER_DIR && git pull
fi

cd $INSTALLER_DIR

# --- Check if mtprotoproxy.sh exists ---
if [ ! -f "mtprotoproxy.sh" ]; then
    echo -e "${RED}فایل mtprotoproxy.sh موجود نیست. لطفاً ساختار پروژه را بررسی کنید.${NC}"
    exit 1
fi

# --- Run the mtprotoproxy.sh script ---
echo -e "${YELLOW}در حال اجرای اسکریپت نصب MTProtoProxy از mtprotoproxy.sh...${NC}"
bash mtprotoproxy.sh

if [ $? -ne 0 ]; then
    echo -e "${RED}خطا در اجرای اسکریپت mtprotoproxy.sh. لطفاً لاگ‌ها را بررسی کنید.${NC}"
    exit 1
fi

echo -e "${GREEN}نصب MTProtoProxy با موفقیت انجام شد!${NC}"
echo -e "${GREEN}اطلاعات اتصال پروکسی شما باید پس از اتمام اسکریپت mtprotoproxy.sh نمایش داده شده باشد.${NC}"
echo ""
echo -e "${YELLOW}برای بررسی وضعیت سرویس، می‌توانید از دستور زیر استفاده کنید:${NC}"
echo -e "${YELLOW}systemctl status mtproxy${NC}"
echo ""
echo -e "${YELLOW}برای دیدن لاگ‌ها:${NC}"
echo -e "${YELLOW}journalctl -u mtproxy -f${NC}"
echo ""
