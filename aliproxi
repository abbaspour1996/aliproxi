#!/bin/bash

# Define colors for better output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}سلام علی جان، اسکریپت به‌روزرسانی پروکسی MTProtoProxy در حال اجراست!${NC}"
echo -e "${YELLOW}این اسکریپت به‌طور خودکار هر یک دقیقه پروکسی شما رو به‌روزرسانی می‌کند.${NC}"

# --- Function to check if a command exists ---
command_exists () {
    type "$1" &> /dev/null ;
}

# --- Check for root privileges ---
if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}خطا: این اسکریپت باید با دسترسی روت اجرا بشه. لطفاً از 'sudo su -' یا 'sudo ./scriptname.sh' استفاده کنید.${NC}"
   exit 1
fi

# --- Install expect if it's not installed ---
command_exists expect || {
    echo -e "${YELLOW}پکیج expect نصب نیست. در حال نصب...${NC}"
    apt install -y expect
}

# --- Directory of MTProtoProxyInstaller ---
INSTALLER_DIR="/opt/MTProtoProxyInstaller"
if [ ! -d "$INSTALLER_DIR" ]; then
    echo -e "${RED}دایرکتوری MTProtoProxyInstaller پیدا نشد. لطفاً پروژه را دانلود کنید.${NC}"
    exit 1
fi

cd $INSTALLER_DIR

# --- Infinite loop to automatically select "Upgrade proxy software" every minute ---
while true; do
    echo -e "${YELLOW}در حال به‌روزرسانی پروکسی...${NC}"
    
    # Use expect to interact with the script
    expect <<EOF
    spawn bash MTProtoProxyInstall.sh
    expect "Please enter a number:"
    send "2\r"
    expect "Please enter a number:"
    send "2\r"
    expect eof
EOF

    # Delay for 1 minute before repeating
    sleep 60
done
